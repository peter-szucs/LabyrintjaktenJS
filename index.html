<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <img id="logga" src="Logga.png">
    <img id="healthimg" src="Health.png">
    <img id="healthbar" src="Healthbar.png">
    <img id="cog" src="SettingsCog.png" onclick="pauseToggle()">
    <canvas id="bgCanvas" width="352" height="576"></canvas>
    <canvas id="pcCanvas" width="352" height="576"></canvas>
    <canvas id="middleCanvas" width="375" height="812"></canvas>
    <canvas id="overlayCanvas" width="375" height="812"></canvas>
    <input type="button" id="upButton" class="button" onmousedown="playerUp=true" onmouseup="playerUp=false" value="Upp">
    <input type="button" id="leftButton" class="button" onmousedown="playerLeft=true" onmouseup="playerLeft=false" value=" V ">
    <input type="button" id="rightButton" class="button" onmousedown="playerRight=true" onmouseup="playerRight=false" value=" H ">
    <input type="button" id="downButton" class="button" onmousedown="playerDown=true" onmouseup="playerDown=false" value="Ner">
    <div id="bool">
        <p id="bool2"></p>
        <p id="bool3"></p>
        <p id="bool4"></p>
        <p id="bool5"></p>
    </div>
    <script>
        let paused = false;
        let loop = true;
        let health = 3;
        let overlayCanvas = document.getElementById('overlayCanvas');
        let middleCanvas = document.getElementById('middleCanvas');
        let pcCanvas = document.getElementById('pcCanvas');
        let bgCanvas = document.getElementById('bgCanvas');
        let ctxPc = pcCanvas.getContext('2d');
        let ctxBg = bgCanvas.getContext('2d');
        let ctxM = middleCanvas.getContext('2d');
        let ctxO = overlayCanvas.getContext('2d');
        let walls = [];
        let allowedPath = [];
        let gameTiles = 32;
        let mapArray = [
            [5, 1, 9, 1, 1, 1, 1, 1, 1, 1, 6],
            [3, 0, 14, 0, 0, 0, 0, 0, 0, 0, 4],
            [3, 0, 14, 0, 16, 0, 26, 13, 13, 13, 12],
            [3, 0, 15, 0, 14, 0, 14, 0, 0, 0, 4],
            [3, 0, 0, 0, 14, 0, 15, 0, 18, 13, 12],
            [11, 13, 13, 13, 24, 0, 0, 0, 0, 0, 4],
            [3, 0, 0, 0, 0, 0, 26, 13, 25, 0, 4],
            [3, 0, 26, 13, 13, 13, 24, 0, 14, 0, 4],
            [3, 0, 15, 0, 0, 0, 0, 0, 23, 13, 12],
            [3, 0, 0, 0, 16, 0, 16, 0, 0, 0, 4],
            [11, 13, 13, 13, 21, 0, 23, 13, 13, 13, 12],
            [3, 0, 0, 0, 14, 0, 0, 0, 0, 0, 0],
            [3, 0, 16, 0, 14, 0, 18, 13, 25, 0, 4],
            [3, 0, 14, 0, 15, 0, 0, 0, 14, 0, 4],
            [3, 0, 14, 0, 0, 0, 16, 0, 14, 0, 4],
            [3, 0, 23, 13, 13, 13, 20, 13, 24, 0, 4],
            [3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4],
            [8, 2, 2, 2, 2, 2, 2, 2, 2, 2, 7]
        ];
        let startScreenBG = new Image();
        let startScreenLogo = new Image();
        let playButton = new Image();
        let smoke = new Image();
        let tileSheet = new Image();
        let playerChar = new Image();
        let monsterChar1 = new Image();
        
        startScreenBG.src = "startScreenBG.png";
        startScreenLogo.src = "startScreenLogo.png"
        playButton.src = "spelaButton.png"
        smoke.src = "smoke2_8.png"
        tileSheet.src = "Tilesheet.png";
        playerChar.src = 'PCTilesheet.png';
        monsterChar1.src = 'Monster1TileSheet.png'

        tileSheet.onload = function() {
            draw();
        }
        // playerChar.onload = function() {
        //     ctxPc.drawImage(playerChar, 100, 68, 32, 41);
        // }

        function draw() {
            var posX = 0;
            var posY = 0;
            for (var i = 0; i < mapArray.length; i++) {
                for (var j = 0; j < mapArray[i].length; j++) {
                    var value = mapArray[i][j];
                    var sourceX = (value % 6) * 32;
                    var sourceY = Math.floor(value / 6) * 32;
                    ctxBg.drawImage(tileSheet, sourceX, sourceY, 32, 32, posX, posY, 32, 32);
                    if (value == 0) {
                        allowedPath.push([posX, posY])
                    }
                    if (value != 0 && value > 12) {
                        walls.push([posX, posY]);
                    }
                    posX += 32;
                }
                posX = 0;
                posY += 32;
            }
        }

        function drawPlayer(frameX, frameY, canvasX, canvasY) {
            ctxPc.drawImage(playerChar, frameX * 32, frameY * 41, 32, 41, canvasX, canvasY, 32, 41)
        }

        function drawMonster(frameX, frameY, canvasX, canvasY) {
            ctxPc.drawImage(monsterChar1, frameX * 32, frameY * 41, 32, 41, canvasX, canvasY, 32, 41)
        }
        const animationLoop = [0, 1, 0, 2];
        let currentLoopIndex = 0;
        let frameCount = 0;
        const facingDown = 0;
        const facingUp = 3;
        const facingLeft = 1;
        const facingRight = 2;
        let currentDirection = facingDown;

        const moveSpeed = 1;
        const monsterMoveSpeed = 0.5;
        let playerX = 32;
        let playerY = 23;
        let playerUp = false;
        let playerDown = false;
        let playerLeft = false;
        let playerRight = false;
        let monster1StartX = 5 * gameTiles;
        let monster1EndX = (4 * gameTiles) + monster1StartX;
        let monsterPosX = 5 * gameTiles
        let monsterPosY = (5 * gameTiles) - 12;
        const monster1FaceRight = 0;
        const monster1FaceLeft = 1;
        let monster1CurrentDirection = monster1FaceRight;
        let monster1FrameCount = 0;
        let monster1CurrentLoopIndex = 0;
        const frameLimit = 12;
        let playerCollision = false;
        
        let playerCell = 0;
        let lastDirection = true;
        let  withinPath = true;

        let monsterStart = true;
        let monsterEnd = false;

        let smokeX = 0;

        var currentGameState = startGame;
        window.requestAnimationFrame(mainLoop);
        

        var bX = 40;
        var bY = 80;
        var bW = 100;
        var bH = 50;

        function startGame() {
            ctxO.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            ctxM.clearRect(0, 0, middleCanvas.width, middleCanvas.height);
            ctxM.drawImage(startScreenBG, 0, 0);
            ctxO.drawImage(startScreenLogo, 16, 87);
            ctxO.drawImage(playButton, 73, 609);
            moveSmoke(-0.2);
            overlayCanvas.addEventListener('click', function(event) {
                if (
                    event.x > 0 &&
                    event.x < overlayCanvas.width &&
                    event.y > 0 &&
                    event.y < overlayCanvas.height
                ) { 
                    afterStart();
                }
            });
        }
        function moveSmoke(deltaX) {
            smokeX += deltaX;
            drawSmoke(smokeX, 0);
        }
        function drawSmoke(canvasX, canvasY) {
            ctxM.drawImage(smoke, canvasX, canvasY)
        }

        function afterStart() {
            ctxO.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            ctxM.clearRect(0, 0, middleCanvas.width, middleCanvas.height);
            document.getElementById("overlayCanvas").style.pointerEvents = "none";
            document.getElementById("middleCanvas").style.pointerEvents = "none";
            currentGameState = gameLoop;
        }

        function clickOnCanvas() {
            ctxO.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            ctxM.clearRect(0, 0, middleCanvas.width, middleCanvas.height);
            currentGamestate = gameLoop;
        }
        function pause() {
            // ctxO.font = "30px Arial";
            // ctxO.filltext("Paused");
            if (paused) {
                paused = false;
                currentGameState = gameLoop;
            }
        }
        
        function gameLoop() {
            ctxPc.clearRect(0, 0, pcCanvas.width, pcCanvas.height);
            let hasMoved = false;
            document.getElementById("bool5").innerHTML = playerCell;
            whatPlayerCell();
            if (playerUp == true) {
                currentDirection = facingUp;
                lastDirection = true;
                hasMoved = true;
                collision();
                moveCharacter(0, -moveSpeed, facingUp);
            } else if (playerDown == true) {
                currentDirection = facingDown;
                lastDirection = true;
                hasMoved = true;
                collision();
                moveCharacter(0, moveSpeed, facingDown);
            }
            if (playerLeft == true) {
                currentDirection = facingLeft;
                lastDirection = true;
                hasMoved = true;
                collision();
                moveCharacter(-moveSpeed, 0, facingLeft);
            } else if (playerRight == true) {
                currentDirection = facingRight;
                lastDirection = false;
                hasMoved = true;
                collision();
                moveCharacter(moveSpeed, 0, facingRight);
            }
            if (hasMoved) {
                frameCount++
                if (frameCount >= frameLimit) {
                    frameCount = 0;
                    currentLoopIndex++;
                    if (currentLoopIndex >= animationLoop.length) {
                        currentLoopIndex = 0;
                    }
                }
            }
            if (monsterPosX == monster1StartX) {
                monsterStart = true;

                monsterEnd = false;
            } else if (monsterPosX == monster1EndX) {
                monsterStart = false;

                monsterEnd = true;
            }
            monster1Walk(monsterStart, monsterEnd);
            if (!hasMoved) {
                currentLoopIndex = 0;
            }
            drawPlayer(animationLoop[currentLoopIndex], currentDirection, playerX, playerY);
            drawMonster(animationLoop[monster1CurrentLoopIndex], monster1CurrentDirection, monsterPosX, monsterPosY)
            if (paused) {
                paused = false;
                currentGameState = pause;
            }
            //window.requestAnimationFrame(gameLoop);
        }

        function mainLoop() {
            //document.getElementById("bool2").innerHTML = currentGameState;
            currentGameState();
            window.requestAnimationFrame(mainLoop);
        }
        //gameLoop();
        

        function moveCharacter(deltaX, deltaY, direction) {
            var clippingPosY = playerY + 12;
            var clippingPosX = playerX + 2;
            if (deltaX == -1) {
                if (playerPathX(allowedPath[playerCell][0], allowedPath[playerCell][1], deltaX, 0)) {
                    playerX += deltaX
                }
            } else if (deltaX == 1) {
                if (playerPathX(allowedPath[playerCell][0], allowedPath[playerCell][1], deltaX, 0)) {
                    playerX += deltaX
                }
            }
            if (deltaY == -1) {
                if (playerPathY(allowedPath[playerCell][0], allowedPath[playerCell][1], 0, deltaY)) {
                    playerY += deltaY
                }
            } else if (deltaY == 1) {
                if (playerPathY(allowedPath[playerCell][0], allowedPath[playerCell][1], 0, deltaY)) {
                    playerY += deltaY
                }
            }
            currentDirection = direction;
        }

        function monster1Walk(monsterStart, monsterEnd) {

            if (monsterStart) {
                monster1CurrentDirection = monster1FaceRight;
                monster1FrameCount++
                if (monster1FrameCount >= frameLimit) {
                    monster1FrameCount = 0;
                    monster1CurrentLoopIndex++;
                    if (monster1CurrentLoopIndex >= animationLoop.length) {
                        monster1CurrentLoopIndex = 0;
                    }
                }
                monsterPosX += monsterMoveSpeed;
            } else if (monsterEnd) {
                monsterPosX -= monsterMoveSpeed;
                monster1CurrentDirection = monster1FaceLeft;
                monster1FrameCount++
                if (monster1FrameCount >= frameLimit) {
                    monster1FrameCount = 0;
                    monster1CurrentLoopIndex++; 
                    if (monster1CurrentLoopIndex >= animationLoop.length) {
                        monster1CurrentLoopIndex = 0;
                    }
                }
            }
        }
        function collision() {
            for (let i = 0; i < walls.length; i++) {
                if (walls[i][0] < playerX + 32 &&
                    walls[i][0] + 32 > playerX &&
                    walls[i][1] < playerY + 9 + 32 &&
                    walls[i][1] + 32 > playerY + 9) {
                    playerCollision = true;
                }

            }
        }
        function whatPlayerCell() {
            for (let i = 0; i < allowedPath.length; i++) {
                if (playerX + 10 > allowedPath[i][0] &&
                    playerX + 20 < allowedPath[i][0] + 32 &&
                    playerY + 19 >= allowedPath[i][1] &&
                    playerY + 40 <= allowedPath[i][1] + 32) {
                        playerCell = i;
                    }
            }
        }

        // function whatPlayerCell() {
        //     for (let i = 0; i < allowedPath.length; i++) {
        //         if (playerX + 2 > allowedPath[i][0] &&
        //             playerX + 2 < allowedPath[i][0] + 32 &&
        //             playerY + 40 >= allowedPath[i][1] &&
        //             playerY + 40 <= allowedPath[i][1] + 32) {
        //                 playerCell = i;
        //             }
        //     }
        // }

        // function whatPlayerCellRight() {
        //     for (let i = 0; i < allowedPath.length; i++) {
        //         if (playerX + 26 > allowedPath[i][0] &&
        //             playerX + 26 < allowedPath[i][0] + 32 &&
        //             playerY + 40 >= allowedPath[i][1] &&
        //             playerY + 40 <= allowedPath[i][1] + 32) {
        //                 playerCell = i;
        //             }
        //     }
        // }

        function playerPathX(x, y, deltaX, deltaY) {
            var leftCellX = 0;
            var leftCellY = 0;
            var rightCellX = 0;
            var rightCellY = 0;
            var newShapeX = 0;
            var newShapeY = 0;
            var newShapeW = 32;
            var go = false;
            for (let i = 0; i < allowedPath.length; i++) {
                if (x == allowedPath[i][0] + 32 &&
                    y == allowedPath[i][1]) {
                        leftCellX = allowedPath[i][0];
                        leftCellY = allowedPath[i][1];
                    }
                if (x + 32 == allowedPath[i][0] &&
                    y == allowedPath[i][1]) {
                        rightCellX = allowedPath[i][0];
                        rightCellY = allowedPath[i][1]; 
                    }
            }
            if (!leftCellX == 0) {
                newShapeX = leftCellX;
                newShapeY = leftCellY;
                newShapeW += 32;
            }
            else if (leftCellX == 0) {
                newShapeX = x;
                newShapeY = y;
            }
            if (!rightCellX == 0) {
                newShapeW += 32;
            }
            document.getElementById("bool2").innerHTML = "X-Led Shape: X: " + newShapeX + " Y: " + newShapeY + " W: " + newShapeW;
            go = withinBounds(newShapeX, newShapeY, newShapeW, deltaX, deltaY);
            withinPath = go;
            return go;

        }

        function playerPathY(x, y, deltaX, deltaY) {
            var upCellX = 0;
            var upCellY = 0;
            var downCellX = 0;
            var downCellY = 0;
            var newShapeX = 0;
            var newShapeY = 0;
            var newShapeH = 32;
            var go = false;
            for (let i = 0; i < allowedPath.length; i++) {
                if (x == allowedPath[i][0] &&
                    y == allowedPath[i][1] + 32) {
                        upCellX = allowedPath[i][0];
                        upCellY = allowedPath[i][1];
                    }
                if (x == allowedPath[i][0] &&
                    y + 32 == allowedPath[i][1]) {
                        downCellX = allowedPath[i][0];
                        downCellY = allowedPath[i][1];
                    }
            }
            if (!upCellX == 0) {
                newShapeX = upCellX;
                newShapeY = upCellY;
                newShapeH += 32;
            }
            if (upCellX == 0) {
                newShapeX = x;
                newShapeY = y;
            }
            if (!downCellX == 0) {
                newShapeH += 32;
            }
            document.getElementById("bool3").innerHTML = "Y-Led shape: X: " + newShapeX + " Y: " + newShapeY + " H: " + newShapeH;
            go = withinBounds(newShapeX, newShapeY, newShapeH, deltaX, deltaY);
            withinPath = go;
            return go;

        }

        function withinBounds(x, y, wh, deltaX, deltaY) {
            pClipX = playerX + 2;
            pClipY = playerY + 11;
            playerW = 24;
            playerH = 30;
            if (pClipX + deltaX > x &&
                pClipX + playerW + deltaX < x + wh &&
                pClipY + deltaY > y &&
                pClipY + playerH + deltaY < y + wh) {
                return true;
            } else
                return false;
        }
        function pauseToggle() {
            if (!paused) {
                paused = true;
            }
            else if (paused) {
                paused = false;
            }
            document.getElementById("bool4").innerHTML = paused;
        }
        function test() {
            document.getElementById("bool4").innerHTML = "Trycka !!!"
        }
    </script>
</body>

</html>