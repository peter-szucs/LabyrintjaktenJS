<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width-device-width, initial-scale = 1.0">
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <img id="logga" src="Logga.png">
        <canvas id="bgCanvas" width="352" height="576"></canvas>
        <canvas id="pcCanvas" width="352" height="576"></canvas>
        <canvas id="wallCanvas" width="352" height="455"></canvas>
        <input type="button" id="upButton" class="button" onmousedown="playerUp=true" onmouseup="playerUp=false" value="Upp">
        <input type="button" id="leftButton" class="button" onmousedown="playerLeft=true" onmouseup="playerLeft=false" value=" V ">
        <input type="button" id="rightButton" class="button" onmousedown="playerRight=true" onmouseup="playerRight=false" value=" H ">
        <input type="button" id="downButton" class="button" onmousedown="playerDown=true" onmouseup="playerDown=false" value="Ner">
        <script>
            //window.onload = function() {
                var loop = true;
                var wallCanvas = document.getElementById('wallCanvas');
                var pcCanvas = document.getElementById('pcCanvas');
                var bgCanvas = document.getElementById('bgCanvas');
                var ctxWalls = wallCanvas.getContext('2d');
                var ctxPc = pcCanvas.getContext('2d');
                var ctxBg = bgCanvas.getContext('2d');
                var allowedPathX = [];
                var allowedPathY = [];
                var walls = [];
                var gameTiles = 32;
                var mapArray = [
                    [5, 1, 9,  1, 1,  1, 1, 1, 1, 1, 6],
                    [3, 0, 14, 0, 0,  0, 0, 0, 0, 0, 4],
                    [3, 0, 14, 0, 16, 0, 26,13,13,13,12],
                    [3, 0, 15, 0, 14, 0, 14,0, 0, 0, 4],
                    [3, 0, 0,  0, 14, 0, 15,0, 18,13,12],
                    [11,13,13, 13,24, 0, 0, 0, 0, 0, 4],
                    [3, 0, 0,  0, 0,  0, 26,13,25,0, 4],
                    [3, 0, 26, 13,13,13, 24,0, 14,0, 4],
                    [3, 0, 15, 0, 0,  0, 0, 0, 23,13,12],
                    [3, 0, 0,  0, 16, 0, 16,0, 0, 0, 4],
                    [11,13,13, 13,21, 0, 23,13,13,13,12],
                    [3, 0, 0,  0, 14, 0, 0, 0, 0, 0, 0],
                    [3, 0, 16, 0, 14, 0, 18,13,25,0, 4],
                    [3, 0, 14, 0, 15, 0, 0, 0, 14,0, 4],
                    [3, 0, 14, 0, 0,  0, 16,0, 14,0, 4],
                    [3, 0, 23, 13,13, 13,20,13,24,0, 4],
                    [3, 0, 0,  0, 0,  0, 0, 0, 0, 0, 4],
                    [8, 2, 2,  2, 2,  2, 2, 2, 2, 2, 7]
                ];
                var tileSheet = new Image();
                var playerChar = new Image();
                var monsterChar1 = new Image();
                
                tileSheet.src = "Tilesheet.png";
                playerChar.src = 'PCTilesheet.png';
                monsterChar1.src = 'Monster1.png'

                tileSheet.onload = function() {
                    draw();
                }
                playerChar.onload = function() {
                    ctxPc.drawImage(playerChar, 100, 68, 32, 41);
                }
                function draw() {
                    var posX = 0;
                    var posY = 0;
                    for (var i = 0; i < mapArray.length; i++) {
                        for (var j = 0; j < mapArray[i].length; j++) {
                            var value = mapArray[i][j];
                            var sourceX = (value % 6) * 32;
                            var sourceY = Math.floor(value / 6) * 32;
                            ctxBg.drawImage(tileSheet, sourceX, sourceY, 32, 32, posX, posY, 32, 32);
                            if (value == 0) {
                                allowedPathX.push(posX);
                                allowedPathY.push(posY);
                            }
                            if (value != 0) {
                                walls.push([posX, posY]);
                            }
                            posX += 32;
                        }
                        posX = 0;
                        posY += 32;
                    }
                }
                function drawPlayer(frameX, frameY, canvasX, canvasY) {
                ctxPc.drawImage(playerChar, frameX * 32, frameY * 41, 32, 41, canvasX, canvasY, 32, 41)
                }
                function drawMonster(x, y) {
                    ctxPc.drawImage(monsterChar1, x, y)
                }
                const animationLoop = [0, 1, 0, 2];
                let currentLoopIndex = 0;
                let frameCount = 0;
                const facingDown = 0;
                const facingUp = 3;
                const facingLeft = 1;
                const facingRight = 2;
                let currentDirection = facingDown;

                const moveSpeed = 1;
                const monsterMoveSpeed = 0.5;
                let positionX = 32;
                let positionY = 12;
                let playerUp = false;
                let playerDown = false;
                let playerLeft = false;
                let playerRight = false;
                // var clippingPosY = positionY + 12;
                // var clippingPosX = positionX + 2;
                let monster1StartX = 5 * gameTiles;
                let monster1EndX = (4 * gameTiles) + monster1StartX;
                let monsterPosX = 5 * gameTiles
                let monsterPosY = (5 * gameTiles) - 12;
                const frameLimit = 12;
                
                
                monsterStart = true;
                monsterEnd = false;
                
                console.log(allowedPathY);
                console.log(walls);
                
                function gameLoop() {
                    ctxPc.clearRect(0, 0, pcCanvas.width, pcCanvas.height);
                    let hasMoved = false;
                    if (playerUp == true) {
                        currentDirection = facingUp;
                        hasMoved = true;
                        moveCharacter(0, -moveSpeed, facingUp);
                    }
                    else if (playerDown == true) {
                        currentDirection = facingDown;
                        moveCharacter(0, moveSpeed, facingDown);
                        hasMoved = true;
                    }
                    if (playerLeft == true) {
                        currentDirection = facingLeft;
                        moveCharacter(-moveSpeed, 0, facingLeft);
                        hasMoved = true;
                    }
                    else if (playerRight == true) {
                        currentDirection = facingRight;
                        moveCharacter(moveSpeed, 0, facingRight);
                        hasMoved = true;
                    }
                    if (hasMoved) {
                        frameCount++
                        if (frameCount >= frameLimit) {
                            frameCount = 0;
                            currentLoopIndex++;
                            if (currentLoopIndex >= animationLoop.length) {
                                currentLoopIndex = 0;
                            }
                        }
                    }
                    if (monsterPosX == monster1StartX) {
                        monsterStart = true;
                    }
                    else if (monsterPosX == monster1EndX) {
                        monsterStart = false;
                        monsterEnd = true;
                    }
                    monsterWalk(monsterStart, monsterEnd);
                    if (!hasMoved) {
                        currentLoopIndex = 0;
                    }
                    drawPlayer(animationLoop[currentLoopIndex], currentDirection, positionX, positionY);
                    drawMonster(monsterPosX, monsterPosY)
                    window.requestAnimationFrame(gameLoop);
                    //console.log(positionX, positionY);
                    //console.log(clippingPosX, clippingPosY);
                }
                gameLoop();
                
                function moveCharacter(deltaX, deltaY, direction) {
                    var clippingPosY = positionY + 12;
                    var clippingPosX = positionX + 2;
                    for (let i = 0; i < walls.length; i++) {
                            if (clippingPosX + deltaX > walls[i][0] + 32 &&
                                clippingPosX + 28 + deltaX < walls[i][0] &&
                                clippingPosY + deltaY > walls[i][1] + 32 &&
                                clippingPosY + 32 + deltaY < walls[i][1]) {
                                    positionX += deltaX;
                                    positionY += deltaY;
                            }
                    }
                    // if (positionX + deltaX > 32 && positionX + 32 + deltaX < pcCanvas.width - 32) {
                    //     //if (positionX + deltaX >)
                    //     positionX += deltaX;
                    // }
                    // if (positionY + deltaY > 0 && positionY + 32 + deltaY < pcCanvas.height - 32) {
                    //     positionY += deltaY;
                    // }
                    currentDirection = direction;
                }

                function monsterWalk(monsterStart, monsterEnd) {
                    
                    if (monsterStart) {
                        monsterPosX += monsterMoveSpeed;
                    }
                    else if (monsterEnd) {
                        monsterPosX -= monsterMoveSpeed;
                    }
                }
            //}
            


        </script>
    </body>
</html>